name: Build iOS IPA

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.7"
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS (no codesign)
        run: flutter build ios --release --no-codesign

      - name: Create unsigned IPA
        run: |
          rm -rf Payload
          mkdir -p Payload
          cp -R build/ios/iphoneos/Runner.app Payload/
          /usr/bin/zip -r ios-app-unsigned.ipa Payload

      - name: Upload unsigned IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: iphone-app-unsigned
          path: ios-app-unsigned.ipa

      - name: Decode signing assets
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        env:
          IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
          IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
        run: |
          echo "$IOS_P12_BASE64" | base64 --decode > ios_signing.p12
          echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > profile.mobileprovision

      - name: Setup keychain and provisioning profile
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        run: |
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import ios_signing.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Create ExportOptions.plist
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_BUNDLE_ID}</key>
              <string>profile</string>
            </dict>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

      - name: Archive signed app
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        run: |
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            archive

      - name: Export signed IPA
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        run: |
          cd ios
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath build/ipa

      - name: Upload signed IPA artifact
        if: ${{ secrets.IOS_P12_BASE64 != '' && secrets.IOS_P12_PASSWORD != '' && secrets.IOS_MOBILEPROVISION_BASE64 != '' && secrets.KEYCHAIN_PASSWORD != '' && secrets.IOS_TEAM_ID != '' && secrets.IOS_BUNDLE_ID != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: iphone-app-signed
          path: ios/build/ipa/*.ipa
